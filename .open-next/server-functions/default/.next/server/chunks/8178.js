"use strict";exports.id=8178,exports.ids=[8178],exports.modules={7941:(e,a,r)=>{r.d(a,{B:()=>s,E:()=>i});var t=r(55511);let n=(0,r(28354).promisify)(t.scrypt);async function i(e){let a=(0,t.randomBytes)(16).toString("hex"),r=await n(e,a,64);return`${a}:${r.toString("hex")}`}async function s(e,a){let[r,i]=a.split(":");if(!r||!i)return!1;let s=await n(e,r,64),o=Buffer.from(i,"hex");return(0,t.timingSafeEqual)(s,o)}},16228:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{f:()=>b});var n=r(42759),i=r(21262),s=r(80586),o=r(35638),d=r(70762),u=r(71682),l=r(32767),c=r(11737),g=r(7941),w=r(90976),h=r(78499),m=e([u,l,c,w,h]);async function f(e,a,r,t){try{let n=await u.db.select().from(l.integrations).where((0,c.and)((0,c.eq)(l.integrations.userId,e),(0,c.eq)(l.integrations.type,a))),i={accessToken:r};if(n.length>0)return await u.db.update(l.integrations).set({config:i,isActive:!0,updatedAt:new Date,organizationId:t||n[0].organizationId}).where((0,c.eq)(l.integrations.id,n[0].id)),n[0].id;{let[r]=await u.db.insert(l.integrations).values({userId:e,type:a,name:`${a.charAt(0).toUpperCase()+a.slice(1)} Integration`,config:i,isActive:!0,organizationId:t}).returning();return r.id}}catch(e){return null}}[u,l,c,w,h]=m.then?(await m)():m;let b={pages:{signIn:"/auth/login",newUser:"/auth/signup",error:"/auth/error",verifyRequest:"/auth/verify"},callbacks:{authorized({auth:e,request:a}){let r=!!e?.user;return!(a.nextUrl.pathname.startsWith("/dashboard")||a.nextUrl.pathname.startsWith("/chat")||a.nextUrl.pathname.startsWith("/integrations")||a.nextUrl.pathname.startsWith("/org"))||!!r},async jwt({token:e,user:a,account:r}){if(a&&(e.role=a.role,e.id=a.id,e.defaultOrganizationId=a.defaultOrganizationId),r&&(e.accessToken=r.access_token,e.provider=r.provider,e.id))try{let a=await (0,h.wV)(e.id);a.length>0&&!e.defaultOrganizationId&&(e.defaultOrganizationId=a[0].id),("salesforce"===r.provider||"hubspot"===r.provider)&&await f(e.id,r.provider,r.access_token,e.defaultOrganizationId)}catch(e){}return e},session:({session:e,token:a})=>(a&&e.user&&(e.user.role=a.role,e.user.id=a.id,e.user.defaultOrganizationId=a.defaultOrganizationId),e)},providers:[(0,i.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,allowDangerousEmailAccountLinking:!0}),(0,s.A)({clientId:process.env.SALESFORCE_CLIENT_ID,clientSecret:process.env.SALESFORCE_CLIENT_SECRET,allowDangerousEmailAccountLinking:!0,authorization:{params:{scope:"openid id profile email address phone full"}}}),(0,o.A)({clientId:process.env.HUBSPOT_CLIENT_ID,clientSecret:process.env.HUBSPOT_CLIENT_SECRET,allowDangerousEmailAccountLinking:!0}),(0,n.A)({id:"credentials",name:"Email and Password",credentials:{email:{label:"Email",type:"email",placeholder:"hello@example.com"},password:{label:"Password",type:"password"}},async authorize(e){let a=d.z.object({email:d.z.string().email(),password:d.z.string().min(8)}).safeParse(e);if(!a.success)return null;let{email:r,password:t}=a.data,n=await (0,w.ht)(r);if(!n||!n.password||!await (0,g.B)(t,n.password))return null;let i=await (0,h.wV)(n.id),s=n.defaultOrganizationId||void 0;if(0===i.length)try{let e=`${n.name||"User"}'s Organization`,a=await (0,h.EC)({name:e,userId:n.id,billingEmail:n.email});a&&(s=a.id)}catch(e){}else i.length>0&&!s&&(s=i[0].id);return{id:n.id,name:n.name,email:n.email,image:n.image,role:n.role,defaultOrganizationId:s}}})]};t()}catch(e){t(e)}})},58178:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{CI:()=>z,Jv:()=>b,Y9:()=>m,j2:()=>f});var n=r(44330),i=r(73215),s=r(71682),o=r(16228),d=r(75228),u=r(28438),l=r(6411),c=r(66052),g=r(57722),w=r(90976);r(7941);var h=e([i,s,o,d,u,l,c,g,w]);[i,s,o,d,u,l,c,g,w]=h.then?(await h)():h;let{handlers:m,auth:f,signIn:b,signOut:z}=(0,n.Ay)({adapter:(0,i._)(s.db,{usersTable:d.V,accountsTable:u.v,sessionsTable:l.M,verificationTokensTable:c.E,authenticatorsTable:g.P}),session:{strategy:"jwt"},...o.f});t()}catch(e){t(e)}})},78499:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Dp:()=>m,EC:()=>l,GM:()=>I,L_:()=>h,RH:()=>v,Sw:()=>c,bR:()=>b,k:()=>g,lf:()=>y,n5:()=>f,o5:()=>z,oD:()=>p,wV:()=>w});var n=r(71682),i=r(32767),s=r(11737),o=r(46142),d=r(10974),u=e([n,i,s]);async function l({name:e,userId:a,logo:r,website:t,billingEmail:u}){let l=(0,d.Yv)(e),c=await q(l),[g]=await n.db.insert(i.organizations).values({id:(0,o.A)(),name:e,slug:c,logo:r,website:t,billingEmail:u,plan:"free"}).returning();await n.db.insert(i.organizationMembers).values({id:(0,o.A)(),organizationId:g.id,userId:a,role:"owner",inviteAccepted:!0});let w=await n.db.query.users.findFirst({where:(0,s.eq)(i.users.id,a)});return w&&!w.defaultOrganizationId&&await n.db.update(i.users).set({defaultOrganizationId:g.id}).where((0,s.eq)(i.users.id,a)),g}async function c(e){return n.db.query.organizations.findFirst({where:(0,s.eq)(i.organizations.id,e),with:{members:{with:{user:!0}}}})}async function g(e){return n.db.query.organizations.findFirst({where:(0,s.eq)(i.organizations.slug,e),with:{members:{with:{user:!0}}}})}async function w(e){return(await n.db.query.organizationMembers.findMany({where:(0,s.eq)(i.organizationMembers.userId,e),with:{organization:!0}})).map(e=>({...e.organization,role:e.role}))}async function h({id:e,name:a,logo:r,website:t,billingEmail:o,plan:d}){let u={};a&&(u.name=a),void 0!==r&&(u.logo=r),void 0!==t&&(u.website=t),void 0!==o&&(u.billingEmail=o),d&&(u.plan=d);let[l]=await n.db.update(i.organizations).set({...u,updatedAt:new Date}).where((0,s.eq)(i.organizations.id,e)).returning();return l}async function m(e){return await n.db.delete(i.organizations).where((0,s.eq)(i.organizations.id,e)),!0}async function f({organizationId:e,userId:a,role:r="member",invitedEmail:t}){let[s]=await n.db.insert(i.organizationMembers).values({id:(0,o.A)(),organizationId:e,userId:a,role:r,invitedEmail:t,inviteAccepted:!t}).returning();return s}async function b({organizationId:e,userId:a,role:r}){let[t]=await n.db.update(i.organizationMembers).set({role:r,updatedAt:new Date}).where((0,s.and)((0,s.eq)(i.organizationMembers.organizationId,e),(0,s.eq)(i.organizationMembers.userId,a))).returning();return t}async function z({organizationId:e,userId:a}){let r=await n.db.query.organizationMembers.findMany({where:(0,s.and)((0,s.eq)(i.organizationMembers.organizationId,e),(0,s.eq)(i.organizationMembers.role,"owner"))});if(1===r.length&&r[0].userId===a)throw Error("Cannot remove the last owner of an organization");return await n.db.delete(i.organizationMembers).where((0,s.and)((0,s.eq)(i.organizationMembers.organizationId,e),(0,s.eq)(i.organizationMembers.userId,a))),!0}async function y({userId:e,organizationId:a}){if(!await n.db.query.organizationMembers.findFirst({where:(0,s.and)((0,s.eq)(i.organizationMembers.userId,e),(0,s.eq)(i.organizationMembers.organizationId,a))}))throw Error("User is not a member of this organization");let[r]=await n.db.update(i.users).set({defaultOrganizationId:a}).where((0,s.eq)(i.users.id,e)).returning();return r}async function p({organizationId:e,userId:a}){return!!await n.db.query.organizationMembers.findFirst({where:(0,s.and)((0,s.eq)(i.organizationMembers.organizationId,e),(0,s.eq)(i.organizationMembers.userId,a))})}async function I({organizationId:e,userId:a,role:r}){let t=await n.db.query.organizationMembers.findFirst({where:(0,s.and)((0,s.eq)(i.organizationMembers.organizationId,e),(0,s.eq)(i.organizationMembers.userId,a))});return!!t&&("owner"===t.role||"admin"===t.role&&"member"===r||t.role===r)}async function q(e){if(!await n.db.query.organizations.findFirst({where:(0,s.eq)(i.organizations.slug,e)}))return e;let a=1,r=`${e}-${a}`;for(;await n.db.query.organizations.findFirst({where:(0,s.eq)(i.organizations.slug,r)});)a++,r=`${e}-${a}`;return r}async function v(e){try{return await n.db.query.organizationMembers.findMany({where:(0,s.eq)(i.organizationMembers.organizationId,e),with:{user:{columns:{id:!0,name:!0,email:!0,image:!0}}}})}catch(e){throw e}}[n,i,s]=u.then?(await u)():u,t()}catch(e){t(e)}})},90976:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{eg:()=>g,ht:()=>u,kg:()=>c,kl:()=>l});var n=r(71682),i=r(32767),s=r(11737),o=r(7941),d=e([n,i,s]);async function u(e){try{return(await n.db.select().from(i.users).where((0,s.eq)(i.users.email,e)))[0]||null}catch(e){return null}}async function l(e){try{return(await n.db.select().from(i.users).where((0,s.eq)(i.users.id,e)))[0]||null}catch(e){return null}}async function c({name:e,email:a,password:r,image:t}){try{if(await u(a))return null;let s=await (0,o.E)(r);return(await n.db.insert(i.users).values({name:e,email:a,password:s,image:t,role:"user"}).returning())[0]}catch(e){return null}}async function g(e,a){try{return(await n.db.update(i.users).set({...a,updatedAt:new Date}).where((0,s.eq)(i.users.id,e)).returning())[0]}catch(e){return null}}[n,i,s]=d.then?(await d)():d,t()}catch(e){t(e)}})}};