(()=>{var e={};e.id=1345,e.ids=[1345],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},10788:e=>{"use strict";e.exports=import("drizzle-orm/mysql-core")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},10974:(e,t,r)=>{"use strict";r.d(t,{$_:()=>c,Yv:()=>o,cn:()=>n,jP:()=>i});var s=r(75986),a=r(8974);function n(...e){return(0,a.QP)((0,s.$)(e))}async function i(e,t){for await(let r of e.textStream)t(r)}function o(e){return e.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-")}function c(){return process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:`http://localhost:${process.env.PORT||3e3}`}},11737:e=>{"use strict";e.exports=import("drizzle-orm")},11997:e=>{"use strict";e.exports=require("punycode")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29447:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>p,POST:()=>u});var a=r(32190),n=r(67319),i=r(71682),o=r(17673),c=e([n,i]);[n,i]=c.then?(await c)():c;let l=new o.z4({apiKey:process.env.OPENAI_API_KEY});async function u(e){try{let{templateId:t,userId:r,channelId:s,threadTs:o,responseUrl:c,integrationId:u}=await e.json();if(!t)return a.NextResponse.json({error:"Template ID is required"},{status:400});let p=u?await i.db.query.integrations.findFirst({where:(e,{eq:t})=>t(e.id,u)}):await i.db.query.integrations.findFirst({where:(e,{eq:t,and:r})=>r(t(e.type,"slack"),t(e.isActive,!0))});if(!p)return a.NextResponse.json({error:"Slack integration not found"},{status:404});let d=r?await i.db.query.promptTemplates.findFirst({where:(e,{eq:s,and:a})=>a(s(e.id,t),s(e.userId,r))}):null;if(d||(d=await i.db.query.promptTemplates.findFirst({where:(e,{eq:r,and:s})=>s(r(e.id,t),r(e.isPublic,!0))})),!d)return a.NextResponse.json({error:"Template not found or you don't have access to it"},{status:404});let m=p.config,g=(0,n.jo)({clientId:process.env.SLACK_CLIENT_ID||"",clientSecret:process.env.SLACK_CLIENT_SECRET||"",signingSecret:process.env.SLACK_SIGNING_SECRET||"",scopes:["chat:write","channels:read","users:read","team:read","chat:write.public","incoming-webhook"],accessToken:m.access_token,refreshToken:m.refresh_token,expiresAt:m.expires_at,teamId:m.team_id,teamName:m.team_name,botUserId:m.bot_user_id,webhookUrl:m.webhook_url}),h=d.variables||[];if(h.length>0){let e=[{type:"section",text:{type:"mrkdwn",text:`*Template: ${d.name}*
${d.description||""}`}},{type:"divider"}];return h.forEach(t=>{e.push({type:"input",block_id:`variable_${t.name}`,label:{type:"plain_text",text:t.name,emoji:!0},element:{type:"plain_text_input",action_id:`value_${t.name}`,placeholder:{type:"plain_text",text:t.description||"Enter a value"}},hint:{type:"plain_text",text:t.description||""}})}),a.NextResponse.json({response_type:"ephemeral",blocks:e,metadata:{template_id:t,channel_id:s,thread_ts:o,response_url:c}})}let z=d.content;await g.sendMessage({channel:s,text:`Using template: *${d.name}*`,thread_ts:o});let _=await l.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"You are a helpful AI assistant integrated with Slack. Provide concise, accurate responses to user queries. Format your responses using Slack markdown when appropriate."},{role:"user",content:z}],temperature:.7});return await g.sendMessage({channel:s,text:_.choices[0].message.content||"No response generated",thread_ts:o}),c&&await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:"Template processed successfully!",replace_original:!1})}),a.NextResponse.json({success:!0})}catch(e){return a.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(){return a.NextResponse.json({message:"Use POST to use a template"})}s()}catch(e){s(e)}})},29610:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{patchFetch:()=>u,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>d});var a=r(96559),n=r(48088),i=r(37719),o=r(29447),c=e([o]);o=(c.then?(await c)():c)[0];let p=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/slack/slack-templates/use/route",pathname:"/api/slack/slack-templates/use",filename:"route",bundlePath:"app/api/slack/slack-templates/use/route"},resolvedPagePath:"/Users/jacob/projects/nuco/src/app/api/slack/slack-templates/use/route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:l,workUnitAsyncStorage:d,serverHooks:m}=p;function u(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:d})}s()}catch(e){s(e)}})},33873:e=>{"use strict";e.exports=require("path")},37830:e=>{"use strict";e.exports=require("node:stream/web")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56473:e=>{"use strict";e.exports=import("drizzle-orm/neon-http")},57075:e=>{"use strict";e.exports=require("node:stream")},57238:e=>{"use strict";e.exports=import("drizzle-orm/sqlite-core")},57975:e=>{"use strict";e.exports=require("node:util")},58025:e=>{"use strict";e.exports=import("drizzle-orm/pg-core")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67319:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{jo:()=>p});var a=r(70762),n=r(58178),i=r(98072),o=r(55511),c=r.n(o),u=e([n]);n=(u.then?(await u)():u)[0];let l=a.z.object({clientId:a.z.string(),clientSecret:a.z.string(),signingSecret:a.z.string().optional(),teamId:a.z.string().optional(),teamName:a.z.string().optional(),botUserId:a.z.string().optional(),webhookUrl:a.z.string().optional(),scopes:a.z.array(a.z.string()).default(["chat:write","channels:read","users:read","team:read","chat:write.public","incoming-webhook"]),accessToken:a.z.string().optional(),refreshToken:a.z.string().optional(),expiresAt:a.z.number().optional()}),d=a.z.object({id:a.z.string(),name:a.z.string(),is_channel:a.z.boolean(),is_group:a.z.boolean(),is_im:a.z.boolean(),is_private:a.z.boolean(),is_mpim:a.z.boolean(),created:a.z.number(),is_archived:a.z.boolean(),is_general:a.z.boolean(),unlinked:a.z.number(),name_normalized:a.z.string(),is_shared:a.z.boolean(),is_org_shared:a.z.boolean(),is_pending_ext_shared:a.z.boolean(),pending_shared:a.z.array(a.z.unknown()),context_team_id:a.z.string(),updated:a.z.number().optional(),parent_conversation:a.z.string().optional(),creator:a.z.string().optional(),is_ext_shared:a.z.boolean().optional(),shared_team_ids:a.z.array(a.z.string()).optional(),pending_connected_team_ids:a.z.array(a.z.string()).optional(),is_member:a.z.boolean().optional(),topic:a.z.object({value:a.z.string(),creator:a.z.string(),last_set:a.z.number()}).optional(),purpose:a.z.object({value:a.z.string(),creator:a.z.string(),last_set:a.z.number()}).optional(),previous_names:a.z.array(a.z.string()).optional(),num_members:a.z.number().optional()}),m=a.z.object({id:a.z.string(),team_id:a.z.string(),name:a.z.string(),deleted:a.z.boolean(),color:a.z.string(),real_name:a.z.string(),tz:a.z.string(),tz_label:a.z.string(),tz_offset:a.z.number(),profile:a.z.object({title:a.z.string().optional(),phone:a.z.string().optional(),skype:a.z.string().optional(),real_name:a.z.string(),real_name_normalized:a.z.string(),display_name:a.z.string(),display_name_normalized:a.z.string(),status_text:a.z.string(),status_emoji:a.z.string(),status_expiration:a.z.number().optional(),avatar_hash:a.z.string(),email:a.z.string().optional(),image_original:a.z.string().optional(),image_24:a.z.string(),image_32:a.z.string(),image_48:a.z.string(),image_72:a.z.string(),image_192:a.z.string(),image_512:a.z.string(),team:a.z.string()}),is_admin:a.z.boolean(),is_owner:a.z.boolean(),is_primary_owner:a.z.boolean(),is_restricted:a.z.boolean(),is_ultra_restricted:a.z.boolean(),is_bot:a.z.boolean(),is_app_user:a.z.boolean(),updated:a.z.number(),has_2fa:a.z.boolean().optional()});a.z.object({channel:a.z.string(),text:a.z.string(),blocks:a.z.array(a.z.record(a.z.unknown())).optional(),thread_ts:a.z.string().optional(),reply_broadcast:a.z.boolean().optional()});class g{constructor(e){this.config=l.parse(e)}getIntegrationId(){return"slack"}getTeamId(){return this.config.teamId||""}getBotUserId(){return this.config.botUserId||""}async getAuthStatus(){let e=await (0,n.j2)();return e?.user&&(0,i.F0)(e,"slack")?{isAuthenticated:!0,accountId:e.user.id}:{isAuthenticated:!1}}async disconnect(){try{return await (0,n.CI)({redirect:!1}),!0}catch(e){return!1}}async authenticate(){try{return await (0,n.Jv)("slack",{redirect:!0}),!0}catch(e){return!1}}async makeRequest(e,t="GET",r){let s=await (0,n.j2)();if(!(0,i.F0)(s,"slack"))throw new i.v3("Not authenticated with Slack");let a=s.token.accessToken,o=`https://slack.com/api/${e}`,c={method:t,headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json; charset=utf-8"}};if(r){if("GET"===t){let e=new URLSearchParams;Object.entries(r).forEach(([t,r])=>{e.append(t,String(r))});let t=e.toString();if(t){let e=o.includes("?")?"&":"?";o=o+e+t}}else c.body=JSON.stringify(r)}let u=await fetch(o,c);if(!u.ok)throw Error(`Slack API error: ${u.statusText}`);let p=await u.json();if(!p.ok)throw Error(`Slack API error: ${p.error||"Unknown error"}`);return p}async getChannels(){return(await this.makeRequest("conversations.list","GET",{types:"public_channel,private_channel",exclude_archived:!0,limit:1e3})).channels.map(e=>d.parse(e))}async getUsers(){return(await this.makeRequest("users.list","GET")).members.map(e=>m.parse(e))}async sendMessage(e){return await this.makeRequest("chat.postMessage","POST",e)}async addReaction(e,t,r){return await this.makeRequest("reactions.add","POST",{channel:e,timestamp:t,name:r})}async removeReaction(e,t,r){return await this.makeRequest("reactions.remove","POST",{channel:e,timestamp:t,name:r})}async getReactions(e,t){return await this.makeRequest("reactions.get","GET",{channel:e,timestamp:t})}async getThreadReplies(e,t,r=100){return await this.makeRequest("conversations.replies","GET",{channel:e,ts:t,limit:r})}async getUserPresence(e){return await this.makeRequest("users.getPresence","GET",{user:e})}async setUserPresence(e){return await this.makeRequest("users.setPresence","POST",{presence:e})}verifySignature(e,t,r){if(!this.config.signingSecret)return!1;let s=c().createHmac("sha256",this.config.signingSecret),[a,n]=e.split("="),i=Math.floor(Date.now()/1e3);if(Math.abs(i-parseInt(t,10))>300)return!1;let o=`${a}:${t}:${r}`,u=s.update(o).digest("hex");return c().timingSafeEqual(Buffer.from(n),Buffer.from(u))}async getAllUsersPresence(){try{let e=await this.getUsers(),t=await Promise.all(e.map(async e=>{let t=await this.getUserPresence(e.id);return{user_id:e.id,user_name:e.name,...t}}));return{ok:!0,users:t}}catch(e){return{ok:!1,error:"Failed to get users presence"}}}}function p(e){return new g(e)}s()}catch(e){s(e)}})},73024:e=>{"use strict";e.exports=require("node:fs")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{},98072:(e,t,r)=>{"use strict";r.d(t,{F0:()=>n,v3:()=>a});class s extends Error{constructor(e){super(e),this.name="IntegrationError"}}class a extends s{constructor(e="Not authenticated with the integration"){super(e),this.name="AuthenticationError"}}function n(e,t){return!!e?.token?.accessToken&&e.token?.provider===t}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,4017,2190,1771,4999,1712,7624,1682,8178],()=>r(29610));module.exports=s})();