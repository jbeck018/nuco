(()=>{var e={};e.id=2924,e.ids=[2924],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3982:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{patchFetch:()=>l,routeModule:()=>u,serverHooks:()=>f,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>p});var n=s(96559),a=s(48088),i=s(37719),c=s(46462),o=e([c]);c=(o.then?(await o)():o)[0];let u=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/slack/analytics/top-channels/route",pathname:"/api/slack/analytics/top-channels",filename:"route",bundlePath:"app/api/slack/analytics/top-channels/route"},resolvedPagePath:"/Users/jacob/projects/nuco/src/app/api/slack/analytics/top-channels/route.ts",nextConfigOutput:"standalone",userland:c}),{workAsyncStorage:d,workUnitAsyncStorage:p,serverHooks:f}=u;function l(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:p})}r()}catch(e){r(e)}})},4573:e=>{"use strict";e.exports=require("node:buffer")},8704:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{HTTPAccessErrorStatus:function(){return s},HTTP_ERROR_FALLBACK_ERROR_CODE:function(){return n},getAccessFallbackErrorTypeByStatus:function(){return c},getAccessFallbackHTTPStatus:function(){return i},isHTTPAccessFallbackError:function(){return a}});let s={NOT_FOUND:404,FORBIDDEN:403,UNAUTHORIZED:401},r=new Set(Object.values(s)),n="NEXT_HTTP_ERROR_FALLBACK";function a(e){if("object"!=typeof e||null===e||!("digest"in e)||"string"!=typeof e.digest)return!1;let[t,s]=e.digest.split(";");return t===n&&r.has(Number(s))}function i(e){return Number(e.digest.split(";")[1])}function c(e){switch(e){case 401:return"unauthorized";case 403:return"forbidden";case 404:return"not-found";default:return}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},10788:e=>{"use strict";e.exports=import("drizzle-orm/mysql-core")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},10974:(e,t,s)=>{"use strict";s.d(t,{$_:()=>o,Yv:()=>c,cn:()=>a,jP:()=>i});var r=s(75986),n=s(8974);function a(...e){return(0,n.QP)((0,r.$)(e))}async function i(e,t){for await(let s of e.textStream)t(s)}function c(e){return e.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-")}function o(){return process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:`http://localhost:${process.env.PORT||3e3}`}},11737:e=>{"use strict";e.exports=import("drizzle-orm")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21820:e=>{"use strict";e.exports=require("os")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31162:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"isNextRouterError",{enumerable:!0,get:function(){return a}});let r=s(8704),n=s(49026);function a(e){return(0,n.isRedirectError)(e)||(0,r.isHTTPAccessFallbackError)(e)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},33873:e=>{"use strict";e.exports=require("path")},39194:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.d(t,{S:()=>o});var n=s(71682),a=s(32767),i=s(11737),c=e([n,a,i]);[n,a,i]=c.then?(await c)():c;class l{async trackEvent(e){try{let t=await n.db.query.slackEventTypes.findFirst({where:(0,i.eq)(a.slackEventTypes.name,e.eventType)});if(!t){let[s]=await n.db.insert(a.slackEventTypes).values({name:e.eventType,description:`Events of type ${e.eventType}`,category:this.getCategoryFromEventType(e.eventType)}).returning();t=s}await n.db.insert(a.slackEvents).values({eventTypeId:t.id,integrationId:e.integrationId,userId:e.userId,organizationId:e.organizationId,slackUserId:e.slackUserId,slackChannelId:e.slackChannelId,slackTeamId:e.slackTeamId,metadata:e.metadata}),e.slackUserId&&await this.updateUserActivity(e.integrationId,e.slackUserId,e.eventType),e.slackChannelId&&await this.updateChannelActivity(e.integrationId,e.slackChannelId,e.eventType,e.slackUserId)}catch(e){}}async trackAIPerformance(e){try{await n.db.insert(a.slackAIPerformance).values(e)}catch(e){}}async updateUserActivity(e,t,s){try{let r=await n.db.query.slackUserActivity.findFirst({where:(0,i.and)((0,i.eq)(a.slackUserActivity.integrationId,e),(0,i.eq)(a.slackUserActivity.slackUserId,t))});if(r){let e={lastActive:new Date,totalInteractions:r.totalInteractions+1,updatedAt:new Date};s.startsWith("command_")?e.commandsUsed=r.commandsUsed+1:"message_received"===s?e.messagesReceived=r.messagesReceived+1:"message_sent"===s?e.messagesSent=r.messagesSent+1:"reaction_received"===s&&(e.reactionsReceived=r.reactionsReceived+1),await n.db.update(a.slackUserActivity).set(e).where((0,i.eq)(a.slackUserActivity.id,r.id))}else await n.db.insert(a.slackUserActivity).values({integrationId:e,slackUserId:t,lastActive:new Date,totalInteractions:1,commandsUsed:+!!s.startsWith("command_"),messagesReceived:+("message_received"===s),messagesSent:+("message_sent"===s),reactionsReceived:+("reaction_received"===s)})}catch(e){}}async updateChannelActivity(e,t,s,r){try{let c=await n.db.query.slackChannelActivity.findFirst({where:(0,i.and)((0,i.eq)(a.slackChannelActivity.integrationId,e),(0,i.eq)(a.slackChannelActivity.slackChannelId,t))});if(c){let o={totalInteractions:c.totalInteractions+1,updatedAt:new Date};s.startsWith("command_")?o.commandsUsed=c.commandsUsed+1:"message_received"===s?o.messagesReceived=c.messagesReceived+1:"message_sent"===s&&(o.messagesSent=c.messagesSent+1),r&&!await n.db.query.slackEvents.findFirst({where:(0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.eq)(a.slackEvents.slackChannelId,t),(0,i.eq)(a.slackEvents.slackUserId,r),(0,i.sql)`${a.slackEvents.timestamp} < NOW()`)})&&(o.uniqueUsers=c.uniqueUsers+1),await n.db.update(a.slackChannelActivity).set(o).where((0,i.eq)(a.slackChannelActivity.id,c.id))}else await n.db.insert(a.slackChannelActivity).values({integrationId:e,slackChannelId:t,totalInteractions:1,commandsUsed:+!!s.startsWith("command_"),messagesReceived:+("message_received"===s),messagesSent:+("message_sent"===s),uniqueUsers:+!!r})}catch(e){}}getCategoryFromEventType(e){if(e.startsWith("command_"))return"command";if(e.startsWith("message_"))return"message";if(e.startsWith("reaction_"))return"reaction";if(e.startsWith("template_"))return"template";if(e.startsWith("ai_"))return"ai";else return"other"}getDateRangeForPeriod(e){let t=new Date,s=new Date;switch(e){case"day":s.setDate(s.getDate()-1);break;case"week":s.setDate(s.getDate()-7);break;case"month":s.setMonth(s.getMonth()-1);break;case"year":s.setFullYear(s.getFullYear()-1);break;case"all":s=new Date(0)}return{startDate:s,endDate:t}}async getEventCountsByType(e,t="month"){try{let{startDate:s,endDate:r}=this.getDateRangeForPeriod(t),c=await n.db.query.slackEventTypes.findMany(),o=new Map;c.forEach(e=>{o.set(e.id,e.name)});let l=await n.db.select({eventTypeId:a.slackEvents.eventTypeId,count:(0,i.sql)`count(*)`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r))).groupBy(a.slackEvents.eventTypeId),u={};return l.forEach(e=>{u[o.get(e.eventTypeId)||"unknown"]=e.count}),u}catch(e){return{}}}async getTopActiveUsers(e,t=10){try{return await n.db.query.slackUserActivity.findMany({where:(0,i.eq)(a.slackUserActivity.integrationId,e),orderBy:[(0,i.desc)(a.slackUserActivity.totalInteractions)],limit:t})}catch(e){return[]}}async getTopActiveChannels(e,t=10){try{return await n.db.query.slackChannelActivity.findMany({where:(0,i.eq)(a.slackChannelActivity.integrationId,e),orderBy:[(0,i.desc)(a.slackChannelActivity.totalInteractions)],limit:t})}catch(e){return[]}}async getAIPerformanceMetrics(e,t="month"){try{let{startDate:s,endDate:r}=this.getDateRangeForPeriod(t),c=await n.db.select({avgResponseTime:(0,i.sql)`avg(${a.slackAIPerformance.responseTime})`,avgFeedbackRating:(0,i.sql)`avg(${a.slackAIPerformance.feedbackRating})`,totalResponses:(0,i.sql)`count(*)`}).from(a.slackAIPerformance).where((0,i.and)((0,i.eq)(a.slackAIPerformance.integrationId,e),(0,i.gte)(a.slackAIPerformance.createdAt,s),(0,i.lte)(a.slackAIPerformance.createdAt,r)));if(0===c.length)return{averageResponseTime:0,averageFeedbackRating:0,totalResponses:0};return{averageResponseTime:c[0].avgResponseTime||0,averageFeedbackRating:c[0].avgFeedbackRating||0,totalResponses:c[0].totalResponses||0}}catch(e){return{averageResponseTime:0,averageFeedbackRating:0,totalResponses:0}}}async getUsageSummary(e,t="month"){try{let{startDate:s,endDate:r}=this.getDateRangeForPeriod(t),c=await n.db.select({count:(0,i.sql)`count(*)`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r))),o=await n.db.select({count:(0,i.sql)`count(distinct ${a.slackEvents.slackUserId})`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r),(0,i.sql)`${a.slackEvents.slackUserId} is not null`)),l=await n.db.select({count:(0,i.sql)`count(distinct ${a.slackEvents.slackChannelId})`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r),(0,i.sql)`${a.slackEvents.slackChannelId} is not null`)),u=await n.db.query.slackEventTypes.findMany(),d=u.filter(e=>"command"===e.category).map(e=>e.id),p=u.filter(e=>"message"===e.category).map(e=>e.id),f=u.filter(e=>"ai"===e.category).map(e=>e.id),v=await n.db.select({count:(0,i.sql)`count(*)`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r),d.length>0?(0,i.sql)`${a.slackEvents.eventTypeId} in ${d}`:(0,i.sql)`1=0`)),m=await n.db.select({count:(0,i.sql)`count(*)`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r),p.length>0?(0,i.sql)`${a.slackEvents.eventTypeId} in ${p}`:(0,i.sql)`1=0`)),y=await n.db.select({count:(0,i.sql)`count(*)`}).from(a.slackEvents).where((0,i.and)((0,i.eq)(a.slackEvents.integrationId,e),(0,i.gte)(a.slackEvents.timestamp,s),(0,i.lte)(a.slackEvents.timestamp,r),f.length>0?(0,i.sql)`${a.slackEvents.eventTypeId} in ${f}`:(0,i.sql)`1=0`));return{totalEvents:c[0]?.count||0,totalUsers:o[0]?.count||0,totalChannels:l[0]?.count||0,commandsUsed:v[0]?.count||0,messagesProcessed:m[0]?.count||0,aiResponses:y[0]?.count||0}}catch(e){return{totalEvents:0,totalUsers:0,totalChannels:0,commandsUsed:0,messagesProcessed:0,aiResponses:0}}}}function o(){return new l}r()}catch(e){r(e)}})},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46462:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{GET:()=>d});var n=s(32190),a=s(58178),i=s(71682),c=s(32767),o=s(11737),l=s(39194),u=e([a,i,c,o,l]);async function d(e){try{let t=await (0,a.j2)();if(!t?.user)return n.NextResponse.json({error:"Unauthorized"},{status:401});let s=e.nextUrl.searchParams,r=s.get("integrationId"),u=s.get("limit"),d=u?parseInt(u,10):10;if(!r)return n.NextResponse.json({error:"Integration ID is required"},{status:400});let p=await i.db.query.integrations.findFirst({where:(0,o.eq)(c.integrations.id,r)});if(!p)return n.NextResponse.json({error:"Integration not found"},{status:404});if(p.userId!==t.user.id&&p.organizationId!==t.user.defaultOrganizationId)return n.NextResponse.json({error:"Unauthorized to access this integration"},{status:403});let f=(0,l.S)(),v=await f.getTopActiveChannels(r,d);return n.NextResponse.json(v)}catch(e){return n.NextResponse.json({error:"Internal server error"},{status:500})}}[a,i,c,o,l]=u.then?(await u)():u,r()}catch(e){r(e)}})},49026:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{REDIRECT_ERROR_CODE:function(){return n},RedirectType:function(){return a},isRedirectError:function(){return i}});let r=s(52836),n="NEXT_REDIRECT";var a=function(e){return e.push="push",e.replace="replace",e}({});function i(e){if("object"!=typeof e||null===e||!("digest"in e)||"string"!=typeof e.digest)return!1;let t=e.digest.split(";"),[s,a]=t,i=t.slice(2,-2).join(";"),c=Number(t.at(-2));return s===n&&("replace"===a||"push"===a)&&"string"==typeof i&&!isNaN(c)&&c in r.RedirectStatusCode}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},51846:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{BailoutToCSRError:function(){return r},isBailoutToCSRError:function(){return n}});let s="BAILOUT_TO_CLIENT_SIDE_RENDERING";class r extends Error{constructor(e){super("Bail out to client-side rendering: "+e),this.reason=e,this.digest=s}}function n(e){return"object"==typeof e&&null!==e&&"digest"in e&&e.digest===s}},52637:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"isPostpone",{enumerable:!0,get:function(){return r}});let s=Symbol.for("react.postpone");function r(e){return"object"==typeof e&&null!==e&&e.$$typeof===s}},52836:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RedirectStatusCode",{enumerable:!0,get:function(){return s}});var s=function(e){return e[e.SeeOther=303]="SeeOther",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e}({});("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},55511:e=>{"use strict";e.exports=require("crypto")},56473:e=>{"use strict";e.exports=import("drizzle-orm/neon-http")},57238:e=>{"use strict";e.exports=import("drizzle-orm/sqlite-core")},57975:e=>{"use strict";e.exports=require("node:util")},58025:e=>{"use strict";e.exports=import("drizzle-orm/pg-core")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},76926:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createDedupedByCallsiteServerErrorLoggerDev",{enumerable:!0,get:function(){return o}});let r=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var s=n(t);if(s&&s.has(e))return s.get(e);var r={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var c=a?Object.getOwnPropertyDescriptor(e,i):null;c&&(c.get||c.set)?Object.defineProperty(r,i,c):r[i]=e[i]}return r.default=e,s&&s.set(e,r),r}(s(61120));function n(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,s=new WeakMap;return(n=function(e){return e?s:t})(e)}let a={current:null},i="function"==typeof r.cache?r.cache:e=>e,c=console.warn;function o(e){return function(...t){c(e(...t))}}i(e=>{try{c(a.current)}finally{a.current=null}})},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},96487:()=>{},96559:(e,t,s)=>{"use strict";e.exports=s(44870)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[4447,4017,2190,1771,4999,1712,1682,8178],()=>s(3982));module.exports=r})();